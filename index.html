<!doctype html>
<meta charset='utf-8'>
<title>Animal Hunt AR</title>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<style>
  body { margin: 0; font-family: Arial; }
  #camera { width: 100%; height: 100vh; display: block; object-fit: cover; }
  #game { position: relative; width: 100%; height: 100vh; overflow: hidden; background: black; }
  .animal { position: absolute; text-shadow: 0 0 10px rgba(0,0,0,0.8); transition: font-size 0.1s, opacity 0.3s; filter: drop-shadow(0 0 5px rgba(255,255,255,0.3)); }
  #timer { position: absolute; top: 20px; right: 20px; z-index: 100; font-size: 36px; font-weight: bold; color: white; background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 10px; }
  #permissionBtn { position: absolute; top: 20px; left: 20px; z-index: 100; padding: 12px 20px; font-size: 16px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
  #permissionBtn:disabled { background: #45a049; }
  
  /* Splash Screens */
  #endScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; z-index: 200; padding: 20px; overflow-y: auto; }
  #endScreen.show { display: flex; flex-direction: column; justify-content: center; align-items: center; }
  
  #scoreScreen { display: none; }
  #scoreScreen.show { display: block; }
  
  .screen-title { font-size: 32px; font-weight: bold; color: white; margin: 30px 0; text-align: center; }
  .animal-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; width: 100%; max-width: 400px; }
  .animal-card { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; text-align: center; border: 2px solid rgba(255,255,255,0.3); cursor: pointer; transition: all 0.2s; }
  .animal-card:active { background: rgba(76,175,80,0.3); transform: scale(0.95); }
  .animal-card-emoji { font-size: 64px; margin-bottom: 10px; }
  .animal-card-name { font-size: 14px; color: #aaa; margin-bottom: 10px; }
  .counter-display { font-size: 28px; color: #4CAF50; font-weight: bold; }
  
  #doneBtn { padding: 15px 40px; font-size: 20px; background: #2196F3; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; margin-top: 30px; }
  
  #finalScore { font-size: 20px; color: white; margin: 20px; text-align: center; line-height: 2; }
  #playAgainBtn { padding: 15px 40px; font-size: 20px; background: #4CAF50; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; margin-top: 30px; }
</style>

<div id="game">
  <video id="camera" autoplay playsinline></video>
  <div id="animals"></div>
  <button id="permissionBtn">Start Hunting</button>
  <div id="timer">20</div>
</div>

<!-- Score Screen -->
<div id="endScreen">
  <div id="scoreScreen">
    <div class="screen-title">How many did you see? üîç</div>
    <div class="animal-grid" id="animalGrid"></div>
    <button id="doneBtn">Done</button>
  </div>
  
  <div id="resultScreen" style="display: none; text-align: center;">
    <div class="screen-title">Your Score! üéâ</div>
    <div id="finalScore"></div>
    <button id="playAgainBtn">Hunt Again</button>
  </div>
</div>

<script>
  const video = document.getElementById('camera');
  const animalsContainer = document.getElementById('animals');
  const timerDisplay = document.getElementById('timer');
  const animalEmojis = { 'ü¶Å': 'Lion', 'üêò': 'Elephant', 'ü¶í': 'Giraffe', 'üêÖ': 'Tiger', 'ü¶ì': 'Zebra', 'üêª': 'Bear', 'ü¶ä': 'Fox', 'üêí': 'Monkey' };
  const animalKeys = Object.keys(animalEmojis);
  
  let placedAnimals = [];
  let tiltForward = 0;
  let motionEnabled = false;
  let gameActive = false;
  let timeLeft = 20;
  let animalCounts = {};
  let animalCountsActual = {};
  let currentRotationAnimal = null;
  
  // Initialize counts
  animalKeys.forEach(animal => {
    animalCounts[animal] = 0;
    animalCountsActual[animal] = 0;
  });

  // Start camera
  navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
    .then(stream => video.srcObject = stream)
    .catch(() => alert('Camera access denied'));

  // Request motion permission
  document.getElementById('permissionBtn').addEventListener('click', async () => {
    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
      try {
        const permission = await DeviceOrientationEvent.requestPermission();
        if (permission === 'granted') {
          motionEnabled = true;
          startGame();
        }
      } catch (error) {
        alert('Motion permission denied');
      }
    } else {
      motionEnabled = true;
      startGame();
    }
  });

  // Track phone tilt
  window.addEventListener('deviceorientation', (event) => {
    tiltForward = event.beta || 0;
  });

  function startGame() {
    gameActive = true;
    document.getElementById('permissionBtn').style.display = 'none';
    placedAnimals = [];
    animalCountsActual = {};
    animalKeys.forEach(animal => {
      animalCountsActual[animal] = 0;
    });
    
    // Start spawning animals every 5 seconds
    spawnNewAnimal();
    let rotationInterval = setInterval(() => {
      if (gameActive) {
        spawnNewAnimal();
      } else {
        clearInterval(rotationInterval);
      }
    }, 5000);

    // Start timer
    let timerInterval = setInterval(() => {
      timeLeft--;
      timerDisplay.textContent = timeLeft;
      
      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        endGame();
      }
    }, 1000);
  }

  function spawnNewAnimal() {
    // Pick a random animal for this 5-second round
    currentRotationAnimal = animalKeys[Math.floor(Math.random() * animalKeys.length)];
    
    // Spawn 3-5 of that animal
    let count = 2 + Math.floor(Math.random() * 4);
    for (let i = 0; i < count; i++) {
      spawnAnimal(currentRotationAnimal);
    }
  }

  function spawnAnimal(animalEmoji) {
    const animal = document.createElement('div');
    animal.className = 'animal';
    animal.textContent = animalEmoji;
    
    const left = Math.random() * 85 + '%';
    const top = Math.random() * 80 + '%';
    animal.style.left = left;
    animal.style.top = top;
    
    const animalObj = {
      element: animal,
      emoji: animalEmoji,
      baseSize: 50 + Math.random() * 30,
      left: left,
      top: top,
      opacity: 0.6 + Math.random() * 0.4
    };
    
    animal.style.fontSize = animalObj.baseSize + 'px';
    animal.style.opacity = animalObj.opacity;
    placedAnimals.push(animalObj);
    animalsContainer.appendChild(animal);
    
    animalCountsActual[animalEmoji]++;

    // Remove after 5 seconds
    setTimeout(() => {
      animal.style.opacity = '0';
      setTimeout(() => {
        animal.remove();
        placedAnimals.splice(placedAnimals.indexOf(animalObj), 1);
      }, 300);
    }, 5000);
  }

  // Update animal sizes based on tilt
  setInterval(() => {
    placedAnimals.forEach(a => {
      let newSize = a.baseSize + (tiltForward * 1.5);
      newSize = Math.max(a.baseSize * 0.7, Math.min(a.baseSize * 3, newSize));
      a.element.style.fontSize = newSize + 'px';
    });
  }, 50);

  function endGame() {
    gameActive = false;
    animalsContainer.innerHTML = '';
    showScoreScreen();
  }

  function showScoreScreen() {
    const grid = document.getElementById('animalGrid');
    grid.innerHTML = '';
    
    // Only show animals that actually appeared
    animalKeys.forEach(emoji => {
      if (animalCountsActual[emoji] > 0) {
        const card = document.createElement('div');
        card.className = 'animal-card';
        card.onclick = () => increaseCount(emoji);
        card.innerHTML = `
          <div class="animal-card-emoji">${emoji}</div>
          <div class="animal-card-name">${animalEmojis[emoji]}</div>
          <div class="counter-display" id="count-${emoji}">0</div>
        `;
        grid.appendChild(card);
      }
    });
    
    document.getElementById('endScreen').classList.add('show');
    document.getElementById('scoreScreen').classList.add('show');
  }

  window.increaseCount = function(emoji) {
    animalCounts[emoji]++;
    document.getElementById('count-' + emoji).textContent = animalCounts[emoji];
  };

  document.getElementById('doneBtn').addEventListener('click', showResults);

  function showResults() {
    document.getElementById('scoreScreen').classList.remove('show');
    document.getElementById('resultScreen').style.display = 'block';
    
    let resultText = '<strong>Here\'s what you saw:</strong><br><br>';
    let correct = 0;
    let total = 0;
    
    animalKeys.forEach(emoji => {
      if (animalCountsActual[emoji] > 0) {
        const saw = animalCounts[emoji];
        const actual = animalCountsActual[emoji];
        const match = saw === actual ? '‚úì' : '‚úó';
        resultText += `${emoji} You said ${saw}, it was ${actual} ${match}<br>`;
        
        if (saw === actual) correct++;
        total++;
      }
    });
    
    resultText += `<br><strong>You got ${correct} out of ${total} correct!</strong>`;
    document.getElementById('finalScore').innerHTML = resultText;
  }

  document.getElementById('playAgainBtn').addEventListener('click', function() {
    document.getElementById('endScreen').classList.remove('show');
    document.getElementById('resultScreen').style.display = 'none';
    document.getElementById('scoreScreen').classList.remove('show');
    document.getElementById('permissionBtn').style.display = 'block';
    timeLeft = 20;
    timerDisplay.textContent = '20';
    animalKeys.forEach(animal => {
      animalCounts[animal] = 0;
    });
  });
</script>
